{% extends "base.html" %}

{% block title %}Admin Dashboard - ParkingPal{% endblock %}

{% block extra_css %}
<style>
    .container {
        background: #fafafa;
        padding: 40px 20px;
        align-items: flex-start;
    }

    .admin-container {
        width: 100%;
        max-width: 1400px;
    }

    /* Header */
    .header-section {
        margin-bottom: 32px;
    }

    .header-section h1 {
        color: #1a1a1a;
        font-size: 2em;
        font-weight: 600;
        margin-bottom: 4px;
        letter-spacing: -0.5px;
    }

    .header-section p {
        color: #666;
        font-size: 1em;
    }

    .admin-badge {
        display: inline-block;
        background:#667eea;
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        margin-left: 12px;
        letter-spacing: 0.5px;
    }

    /* Camera Selection Cards */
    .camera-section {
        margin-bottom: 32px;
    }

    .camera-section h2 {
        color: #1a1a1a;
        margin-bottom: 20px;
        font-size: 1.3em;
        font-weight: 600;
        letter-spacing: -0.5px;
    }

    .camera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
    }

    .camera-card {
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 2px solid #f0f0f0;
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .camera-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        border-color: #667eea;
    }

    .camera-card.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #f5f7ff 0%, #faf5ff 100%);
    }

    .camera-card .icon {
        font-size: 3em;
        margin-bottom: 16px;
        display: block;
    }

    .camera-card.parking .icon { color: #2196F3; }
    .camera-card.entry .icon { color: #4CAF50; }
    .camera-card.exit .icon { color: #FF9800; }

    .camera-card h3 {
        color: #1a1a1a;
        font-size: 1.4em;
        font-weight: 600;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
    }

    .camera-card p {
        color: #666;
        font-size: 0.95em;
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .camera-card .status-indicator {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4CAF50;
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.2);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* View Display Area */
    .view-container {
        display: none;
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid #f0f0f0;
        margin-top: 32px;
    }

    .view-container.active {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 24px;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .view-header {
        grid-column: 1 / -1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
    }

    .view-header h2 {
        color: #1a1a1a;
        font-size: 1.5em;
        font-weight: 600;
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .close-btn {
        background: #f5f5f5;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: #666;
        transition: all 0.3s;
    }

    .close-btn:hover {
        background: #e0e0e0;
        color: #1a1a1a;
    }

    /* Canvas Area */
    .canvas-area {
        background: #f5f5f5;
        border-radius: 12px;
        padding: 20px;
        min-height: 500px;
    }

    .canvas-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #parkingCanvas {
        display: block;
        max-width: 100%;
        height: auto;
        cursor: crosshair;
    }

    /* Controls Sidebar */
    .controls-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .control-section {
        background: #f9f9f9;
        border-radius: 12px;
        padding: 20px;
    }

    .control-section h3 {
        color: #667eea;
        margin-bottom: 12px;
        font-size: 1.1em;
        font-weight: 600;
    }

    .control-btn {
        width: 100%;
        padding: 12px 24px;
        margin: 8px 0;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95em;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .control-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .control-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .control-btn.success {
        background: #10b981;
        color: white;
    }

    .control-btn.success:hover {
        background: #059669;
        transform: translateY(-2px);
    }

    .control-btn.warning {
        background: #f59e0b;
        color: white;
    }

    .control-btn.warning:hover {
        background: #d97706;
        transform: translateY(-2px);
    }

    .control-btn.danger {
        background: #ef4444;
        color: white;
    }

    .control-btn.danger:hover {
        background: #dc2626;
        transform: translateY(-2px);
    }

    .control-btn.secondary {
        background: #6b7280;
        color: white;
    }

    .control-btn.secondary:hover {
        background: #4b5563;
    }

    .info-box {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 0.9em;
        line-height: 1.6;
    }

    .info-box strong {
        display: block;
        margin-bottom: 8px;
        color: #92400e;
    }

    .info-box ul {
        margin-left: 20px;
        color: #78350f;
    }

    .info-box li {
        margin: 4px 0;
    }

    .status-box {
        background: white;
        border-radius: 8px;
        padding: 16px;
        border-left: 4px solid #667eea;
    }

    .status-box h4 {
        color: #667eea;
        margin-bottom: 12px;
        font-size: 1em;
    }

    .status-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.9em;
    }

    .status-item:last-child {
        border-bottom: none;
    }

    .status-item strong {
        color: #667eea;
    }

    .space-list {
        max-height: 300px;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        padding: 10px;
    }

    .space-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin: 4px 0;
        background: #f3f4f6;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9em;
    }

    .space-item:hover {
        background: #e5e7eb;
        transform: translateX(5px);
    }

    .space-item.selected {
        background: #dbeafe;
        border-left: 3px solid #3b82f6;
    }

    .camera-select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.95em;
        margin-bottom: 12px;
        background: white;
        cursor: pointer;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }

    .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .view-container.active {
            grid-template-columns: 1fr;
        }

        .view-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
    }

    @media (max-width: 768px) {
        .camera-grid {
            grid-template-columns: 1fr;
        }

        .header-section h1 {
            font-size: 1.5em;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Header -->
    <div class="header-section">
        <h1>Admin Dashboard</h1>
        <p>Camera Management & Monitoring System</p>
    </div>

    <!-- Camera Selection -->
    <div class="camera-section">
        <h2>Select Camera View</h2>
        <div class="camera-grid">
            <!-- Parking Lot Camera -->
            <div class="camera-card parking" onclick="showCamera('parking')">
                <div class="status-indicator"></div>
                <span class="icon">🅿️</span>
                <h3>Parking Lot</h3>
                <p>Monitor parking spaces and define detection zones</p>
            </div>

            <!-- Entry Gate Camera -->
            <div class="camera-card entry" onclick="showCamera('entry')">
                <div class="status-indicator"></div>
                <span class="icon">🚗</span>
                <h3>Entry</h3>
                <p>Monitor incoming vehicles and detect license plates</p>
            </div>

            <!-- Exit Gate Camera -->
            <div class="camera-card exit" onclick="showCamera('exit')">
                <div class="status-indicator"></div>
                <span class="icon">🚙</span>
                <h3>Exit</h3>
                <p>Monitor outgoing vehicles and detect license plates</p>
            </div>
        </div>
    </div>

    <!-- Parking Lot View with Canvas Editor -->
    <div id="parking-view" class="view-container">
        <div class="view-header">
            <h2>🅿️ Parking Lot Camera - Space Configuration</h2>
            <button class="close-btn" onclick="closeView()">✕ Close View</button>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area">
            <div class="canvas-container" id="canvasContainer">
                <div class="loading">
                    <p>Select a camera to view snapshot</p>
                </div>
            </div>
        </div>

        <!-- Controls Sidebar -->
        <div class="controls-sidebar">
            <!-- Camera Selection -->
            <div class="control-section">
                <h3>Camera Selection</h3>
                <select id="parkingCameraSelect" class="camera-select">
                    <option value="">Select Camera...</option>
                </select>
                <button class="control-btn primary" onclick="refreshParkingSnapshot()">📷 Refresh Snapshot</button>
                <button class="control-btn secondary" onclick="loadParkingCameraList()">🔄 Refresh List</button>
            </div>

            <!-- Instructions -->
            <div class="control-section">
                <div class="info-box">
                    <strong>Instructions:</strong>
                    <ul>
                        <li>Click 4 points to create a space</li>
                        <li>Click on space to select it</li>
                        <li>Press Delete to remove</li>
                        <li>Right-click to cancel</li>
                    </ul>
                </div>
            </div>

            <!-- Actions -->
            <div class="control-section">
                <h3>Actions</h3>
                <button class="control-btn success" onclick="addNewParkingSpace()">➕ New Space</button>
                <button class="control-btn warning" onclick="removeSelectedParkingSpace()">🗑️ Remove Selected</button>
                <button class="control-btn danger" onclick="clearAllParkingSpaces()">❌ Clear All</button>
                <button class="control-btn primary" onclick="saveParkingConfiguration()">💾 Save & Deploy</button>
            </div>

            <!-- Status -->
            <div class="control-section">
                <div class="status-box">
                    <h4>Status</h4>
                    <div class="status-item">
                        <span>Camera:</span>
                        <strong id="parkingCameraStatus">Not Selected</strong>
                    </div>
                    <div class="status-item">
                        <span>Total Spaces:</span>
                        <strong id="parkingTotalSpaces">0</strong>
                    </div>
                    <div class="status-item">
                        <span>Current Points:</span>
                        <strong id="parkingCurrentPoints">0/4</strong>
                    </div>
                    <div class="status-item">
                        <span>Selected:</span>
                        <strong id="parkingSelectedSpace">None</strong>
                    </div>
                </div>
            </div>

            <!-- Space List -->
            <div class="control-section">
                <h3>Parking Spaces</h3>
                <div class="space-list" id="parkingSpaceList"></div>
            </div>
        </div>
    </div>

    <!-- Entry Gate View -->
    <div id="entry-view" class="view-container">
        <div class="view-header">
            <h2>🚗 Entry Gate Camera</h2>
            <button class="close-btn" onclick="closeView()">✕ Close View</button>
        </div>

        <div class="canvas-area">
            <div class="info-box">
                <strong>Status:</strong>
                Monitoring incoming vehicles and automatically detecting license plates. All entries are logged to the system.
            </div>
            <div class="canvas-container">
                <div class="loading">
                    <p>Entry camera feed will appear here</p>
                </div>
            </div>
        </div>

        <div class="controls-sidebar">
            <div class="control-section">
                <h3>Camera Selection</h3>
                <select id="entryCameraSelect" class="camera-select">
                    <option value="">Select Camera...</option>
                </select>
                <button class="control-btn primary" onclick="alert('Entry camera view coming soon!')">📷 View Live Feed</button>
            </div>

            <div class="control-section">
                <div class="status-box">
                    <h4>Recent Entries</h4>
                    <div class="status-item">
                        <span>Last 24 hours:</span>
                        <strong>0</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exit Gate View -->
    <div id="exit-view" class="view-container">
        <div class="view-header">
            <h2>🚙 Exit Gate Camera</h2>
            <button class="close-btn" onclick="closeView()">✕ Close View</button>
        </div>

        <div class="canvas-area">
            <div class="info-box">
                <strong>Status:</strong>
                Monitoring outgoing vehicles and automatically detecting license plates. All exits are logged to the system.
            </div>
            <div class="canvas-container">
                <div class="loading">
                    <p>Exit camera feed will appear here</p>
                </div>
            </div>
        </div>

        <div class="controls-sidebar">
            <div class="control-section">
                <h3>Camera Selection</h3>
                <select id="exitCameraSelect" class="camera-select">
                    <option value="">Select Camera...</option>
                </select>
                <button class="control-btn primary" onclick="alert('Exit camera view coming soon!')">📷 View Live Feed</button>
            </div>

            <div class="control-section">
                <div class="status-box">
                    <h4>Recent Exits</h4>
                    <div class="status-item">
                        <span>Last 24 hours:</span>
                        <strong>0</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentView = null;
    
    // Parking canvas variables
    let parkingCanvas = null;
    let parkingCtx = null;
    let parkingCameraImage = null;
    let parkingSpaces = [];
    let parkingCurrentPoints = [];
    let parkingSelectedSpaceIndex = -1;
    let parkingHoveredSpaceIndex = -1;
    let currentParkingCameraId = '';

    function showCamera(type) {
        closeView();

        document.querySelectorAll('.view-container').forEach(view => {
            view.classList.remove('active');
        });

        document.querySelectorAll('.camera-card').forEach(card => {
            card.classList.remove('active');
        });

        const viewId = `${type}-view`;
        const viewElement = document.getElementById(viewId);
        if (viewElement) {
            viewElement.classList.add('active');
            currentView = type;

            viewElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Initialize parking camera list if parking view
            if (type === 'parking') {
                loadParkingCameraList();
                setInterval(loadParkingCameraList, 5000);
            }
        }

        const selectedCard = document.querySelector(`.camera-card.${type}`);
        if (selectedCard) {
            selectedCard.classList.add('active');
        }
    }

    function closeView() {
        document.querySelectorAll('.view-container').forEach(view => {
            view.classList.remove('active');
        });

        document.querySelectorAll('.camera-card').forEach(card => {
            card.classList.remove('active');
        });

        currentView = null;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Parking Canvas Functions
    function loadParkingCameraList() {
        fetch('/api/cameras')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('parkingCameraSelect');
                const currentValue = select.value;

                select.innerHTML = '<option value="">Select Camera...</option>';

                if (data.cameras.length === 0) {
                    const option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'No cameras detected - waiting...';
                    select.appendChild(option);
                } else {
                    data.cameras.forEach(cam => {
                        const option = document.createElement('option');
                        option.value = cam;
                        option.textContent = `📹 ${cam}`;
                        select.appendChild(option);
                    });

                    if (currentValue && data.cameras.includes(currentValue)) {
                        select.value = currentValue;
                    } else if (data.cameras.length === 1 && !currentValue) {
                        select.value = data.cameras[0];
                        currentParkingCameraId = data.cameras[0];
                        loadParkingCameraSnapshot();
                        loadParkingConfiguration();
                    }
                }
            })
            .catch(err => console.error('Failed to load cameras:', err));
    }

    document.getElementById('parkingCameraSelect').addEventListener('change', function() {
        currentParkingCameraId = this.value;
        if (currentParkingCameraId) {
            updateParkingStatus();
            loadParkingCameraSnapshot();
            loadParkingConfiguration();
        }
    });

    function loadParkingCameraSnapshot() {
        if (!currentParkingCameraId) return;

        const container = document.getElementById('canvasContainer');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading camera snapshot...</p></div>';

        fetch(`/api/camera/${currentParkingCameraId}/snapshot`)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.blob();
            })
            .then(blob => {
                const img = new Image();
                img.onload = function() {
                    container.innerHTML = '<canvas id="parkingCanvas"></canvas>';
                    parkingCanvas = document.getElementById('parkingCanvas');
                    parkingCtx = parkingCanvas.getContext('2d');

                    parkingCanvas.width = img.width;
                    parkingCanvas.height = img.height;
                    parkingCameraImage = img;

                    setupParkingCanvasListeners();
                    redrawParkingCanvas();

                    console.log(`✓ Snapshot loaded: ${img.width}x${img.height}`);
                };
                img.onerror = function() {
                    container.innerHTML = '<div class="loading"><p style="color: #ef4444;">❌ Failed to load image</p></div>';
                };
                img.src = URL.createObjectURL(blob);
            })
            .catch(err => {
                console.error('Snapshot load error:', err);
                container.innerHTML = `
                    <div class="loading">
                        <p style="color: #ef4444;">❌ Failed to load snapshot</p>
                        <p style="font-size: 12px; color: #6b7280;">
                            Make sure camera "${currentParkingCameraId}" is running and sending snapshots.
                        </p>
                        <button class="control-btn primary" onclick="refreshParkingSnapshot()" style="margin-top: 10px;">
                            Try Again
                        </button>
                    </div>
                `;
            });
    }

    function refreshParkingSnapshot() {
        if (!currentParkingCameraId) {
            alert('Please select a camera first');
            return;
        }
        loadParkingCameraSnapshot();
    }

    function loadParkingConfiguration() {
        if (!currentParkingCameraId) return;

        fetch(`/api/camera/${currentParkingCameraId}/config`)
            .then(r => r.json())
            .then(data => {
                if (data.spaces) {
                    parkingSpaces = data.spaces;
                    redrawParkingCanvas();
                    updateParkingSpaceList();
                    updateParkingStatus();
                }
            })
            .catch(err => console.error('Failed to load config:', err));
    }

    function saveParkingConfiguration() {
        if (!currentParkingCameraId) {
            alert('Please select a camera first');
            return;
        }

        const config = {
            camera_id: currentParkingCameraId,
            spaces: parkingSpaces,
            image_width: parkingCanvas ? parkingCanvas.width : 0,
            image_height: parkingCanvas ? parkingCanvas.height : 0
        };

        fetch(`/api/camera/${currentParkingCameraId}/config`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        })
        .then(r => r.json())
        .then(data => {
            alert('✓ Configuration saved and deployed to camera!');
            console.log(data);
        })
        .catch(err => {
            alert('✗ Failed to save configuration');
            console.error(err);
        });
    }

    function addNewParkingSpace() {
        parkingCurrentPoints = [];
        parkingSelectedSpaceIndex = -1;
        redrawParkingCanvas();
        updateParkingStatus();
    }

    function removeSelectedParkingSpace() {
        if (parkingSelectedSpaceIndex >= 0) {
            parkingSpaces.splice(parkingSelectedSpaceIndex, 1);
            parkingSelectedSpaceIndex = -1;
            redrawParkingCanvas();
            updateParkingSpaceList();
            updateParkingStatus();
        } else {
            alert('Please select a space first');
        }
    }

    function clearAllParkingSpaces() {
        if (confirm('Are you sure you want to clear all parking spaces?')) {
            parkingSpaces = [];
            parkingCurrentPoints = [];
            parkingSelectedSpaceIndex = -1;
            redrawParkingCanvas();
            updateParkingSpaceList();
            updateParkingStatus();
        }
    }

    function setupParkingCanvasListeners() {
        if (!parkingCanvas) return;

        parkingCanvas.addEventListener('click', function(e) {
            const rect = parkingCanvas.getBoundingClientRect();
            const x = Math.round((e.clientX - rect.left) * (parkingCanvas.width / rect.width));
            const y = Math.round((e.clientY - rect.top) * (parkingCanvas.height / rect.height));

            const clickedSpace = findParkingSpaceAtPoint(x, y);
            if (clickedSpace >= 0) {
                parkingSelectedSpaceIndex = clickedSpace;
                parkingCurrentPoints = [];
                redrawParkingCanvas();
                updateParkingSpaceList();
                updateParkingStatus();
                return;
            }

            if (parkingCurrentPoints.length < 4) {
                parkingCurrentPoints.push([x, y]);

                if (parkingCurrentPoints.length === 4) {
                    parkingSpaces.push({
                        id: parkingSpaces.length,
                        points: parkingCurrentPoints.slice()
                    });
                    parkingCurrentPoints = [];
                    parkingSelectedSpaceIndex = parkingSpaces.length - 1;
                    updateParkingSpaceList();
                }

                redrawParkingCanvas();
                updateParkingStatus();
            }
        });

        parkingCanvas.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            parkingCurrentPoints = [];
            redrawParkingCanvas();
            updateParkingStatus();
        });

        parkingCanvas.addEventListener('mousemove', function(e) {
            const rect = parkingCanvas.getBoundingClientRect();
            const x = Math.round((e.clientX - rect.left) * (parkingCanvas.width / rect.width));
            const y = Math.round((e.clientY - rect.top) * (parkingCanvas.height / rect.height));

            parkingHoveredSpaceIndex = findParkingSpaceAtPoint(x, y);
            redrawParkingCanvas();
        });
    }

    document.addEventListener('keydown', function(e) {
        if (currentView === 'parking' && e.key === 'Delete' && parkingSelectedSpaceIndex >= 0) {
            removeSelectedParkingSpace();
        }
    });

    function findParkingSpaceAtPoint(x, y) {
        for (let i = parkingSpaces.length - 1; i >= 0; i--) {
            if (isPointInPolygon([x, y], parkingSpaces[i].points)) {
                return i;
            }
        }
        return -1;
    }

    function isPointInPolygon(point, polygon) {
        let inside = false;
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
            const xi = polygon[i][0], yi = polygon[i][1];
            const xj = polygon[j][0], yj = polygon[j][1];

            const intersect = ((yi > point[1]) !== (yj > point[1]))
                && (point[0] < (xj - xi) * (point[1] - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    function redrawParkingCanvas() {
        if (!parkingCanvas || !parkingCtx) return;

        parkingCtx.clearRect(0, 0, parkingCanvas.width, parkingCanvas.height);

        // Draw camera image
        if (parkingCameraImage) {
            parkingCtx.drawImage(parkingCameraImage, 0, 0);
        }

        // Draw existing parking spaces
        parkingSpaces.forEach((space, index) => {
            const isSelected = index === parkingSelectedSpaceIndex;
            const isHovered = index === parkingHoveredSpaceIndex;

            // Fill
            parkingCtx.fillStyle = isSelected ? 'rgba(59, 130, 246, 0.3)' : 
                           isHovered ? 'rgba(251, 191, 36, 0.3)' :
                           'rgba(168, 85, 247, 0.2)';
            parkingCtx.beginPath();
            parkingCtx.moveTo(space.points[0][0], space.points[0][1]);
            for (let i = 1; i < space.points.length; i++) {
                parkingCtx.lineTo(space.points[i][0], space.points[i][1]);
            }
            parkingCtx.closePath();
            parkingCtx.fill();

            // Border
            parkingCtx.strokeStyle = isSelected ? '#3b82f6' : 
                             isHovered ? '#f59e0b' :
                             '#a855f7';
            parkingCtx.lineWidth = isSelected ? 3 : 2;
            parkingCtx.stroke();

            // Points
            space.points.forEach(pt => {
                parkingCtx.fillStyle = isSelected ? '#3b82f6' : '#a855f7';
                parkingCtx.beginPath();
                parkingCtx.arc(pt[0], pt[1], 5, 0, Math.PI * 2);
                parkingCtx.fill();
            });

            // Label
            const center = getCentroid(space.points);
            parkingCtx.fillStyle = '#fff';
            parkingCtx.strokeStyle = '#000';
            parkingCtx.lineWidth = 3;
            parkingCtx.font = 'bold 20px Arial';
            parkingCtx.textAlign = 'center';
            parkingCtx.textBaseline = 'middle';
            parkingCtx.strokeText(index.toString(), center[0], center[1]);
            parkingCtx.fillText(index.toString(), center[0], center[1]);
        });

        // Draw current points being placed
        if (parkingCurrentPoints.length > 0) {
            parkingCtx.strokeStyle = '#10b981';
            parkingCtx.lineWidth = 2;
            parkingCtx.setLineDash([5, 5]);

            parkingCtx.beginPath();
            parkingCtx.moveTo(parkingCurrentPoints[0][0], parkingCurrentPoints[0][1]);
            for (let i = 1; i < parkingCurrentPoints.length; i++) {
                parkingCtx.lineTo(parkingCurrentPoints[i][0], parkingCurrentPoints[i][1]);
            }
            parkingCtx.stroke();
            parkingCtx.setLineDash([]);

            parkingCurrentPoints.forEach((pt, i) => {
                parkingCtx.fillStyle = '#10b981';
                parkingCtx.beginPath();
                parkingCtx.arc(pt[0], pt[1], 6, 0, Math.PI * 2);
                parkingCtx.fill();

                parkingCtx.fillStyle = '#fff';
                parkingCtx.font = 'bold 12px Arial';
                parkingCtx.fillText((i + 1).toString(), pt[0], pt[1] - 12);
            });
        }
    }

    function getCentroid(points) {
        let x = 0, y = 0;
        points.forEach(pt => {
            x += pt[0];
            y += pt[1];
        });
        return [x / points.length, y / points.length];
    }

    function updateParkingSpaceList() {
        const list = document.getElementById('parkingSpaceList');
        list.innerHTML = '';

        parkingSpaces.forEach((space, index) => {
            const item = document.createElement('div');
            item.className = 'space-item' + (index === parkingSelectedSpaceIndex ? ' selected' : '');
            item.innerHTML = `
                <span>Space ${index}</span>
                <span>${space.points.length} points</span>
            `;
            item.onclick = () => {
                parkingSelectedSpaceIndex = index;
                parkingCurrentPoints = [];
                redrawParkingCanvas();
                updateParkingSpaceList();
                updateParkingStatus();
            };
            list.appendChild(item);
        });
    }

    function updateParkingStatus() {
        document.getElementById('parkingCameraStatus').textContent = currentParkingCameraId || 'Not Selected';
        document.getElementById('parkingTotalSpaces').textContent = parkingSpaces.length;
        document.getElementById('parkingCurrentPoints').textContent = `${parkingCurrentPoints.length}/4`;
        document.getElementById('parkingSelectedSpace').textContent = 
            parkingSelectedSpaceIndex >= 0 ? `Space ${parkingSelectedSpaceIndex}` : 'None';
    }
</script>
{% endblock %}